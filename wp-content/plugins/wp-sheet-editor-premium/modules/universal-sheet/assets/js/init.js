function vgseColumnKeyToExportKey(e){if(vgse_editor_settings.export_keys_mapping&&vgse_editor_settings.export_keys_mapping[e])var t=vgse_editor_settings.export_keys_mapping[e];else t=e;return t}jQuery(document).ready(function(){if(!jQuery(".import-csv-modal").length)return!0;jQuery(".import-csv-modal .remodal-confirm").hide();var p=jQuery(".import-csv-form");function i(){var e=p.find(".step.current"),t=p.find(".step.current").prev(".step");e.slideToggle(),e.removeClass("current"),t.show(),t.addClass("current")}p.find(".import-column-bulk-actions select").change(function(e){"unselect"===jQuery(this).val()&&jQuery(".map-columns .map-template select").val("")}),p.find(".toggle-advanced-options").change(function(e){p.find(".advanced-options").slideToggle()}),p.find(".existing-check-csv-field").change(function(e){var t=jQuery(this).val();t&&(p.find(".map-columns .csv-column-name-value").filter(function(){return jQuery(this).val()===t}).parent().find("select").val()?p.find(".wp-field-requires-ignored-column").hide():(p.find(".wp-field-requires-ignored-column").show(),jQuery(this).val("")),jQuery(this).parent(".field-wrapper").next(".field-wrapper").find("option").filter(function(){return jQuery(this).text()===t||"record_id"===t&&"ID"===jQuery(this).text()}).prop("selected",!0).trigger("change"))}),p.find('[name="writing_type"]').change(function(e){jQuery(this).val()&&"all_new"!==jQuery(this).val()?p.find(".field-find-existing-columns").show():p.find(".field-find-existing-columns").hide()}),p.find(".data-input,.step").hide(),p.find(".step").first().show(),p.find(".source").change(function(e){var t=jQuery(this).val();if(p.find(".data-input").hide(),"csv_upload"===t)p.find(".data-input.csv-upload").show();else if("csv_url"===t)p.find(".data-input.csv-url").show();else if("server_file"===t)p.find(".data-input.server-file").show();else if("paste"===t){p.find(".data-input.paste").show(),window.importHOT&&window.importHOT.destroy();var a={minSpareRows:4,wordWrap:!0,allowInsertRow:!0,columnSorting:!0,colHeaders:!1,width:p.width(),height:300},o=document.getElementById("handsontable-paste");window.importHOT=new Handsontable(o,a)}}),p.on("click",".next-step",function(e){e.preventDefault(),function(){var e=p.find(".step.current"),t=p.find(".step.current").next(".step");e.slideToggle(),e.removeClass("current"),t.show(),t.addClass("current")}();var t=p.find(".step.current");if(t.hasClass("preview-step")&&window.vgseImportData&&window.vgseImportData.success){window.importPreviewHOT&&window.importPreviewHOT.destroy();var a={data:window.vgseImportData.data.firstRows,minSpareRows:1,wordWrap:!0,allowInsertRow:!0,columnSorting:!0,colHeaders:window.vgseImportData.data.rowHeaders,width:p.width(),height:170},o=document.getElementById("hot-preview");window.importPreviewHOT=new Handsontable(o,a),jQuery(".import-csv-modal .remodal-confirm").show(),setFormSubmitting()}t.hasClass("write-type")}),p.on("click",".prev-step",function(e){e.preventDefault(),i()}),p.find(".vgse-upload-csv-file").click(function(e){e.preventDefault();var t=jQuery(this),o=t.parents(".data-input");loading_ajax({estado:!0});var a={data:{action:"vgse_upload_file_for_import",data_type:t.data("type"),vgse_plain_mode:"yes",nonce:jQuery("#vgse-wrapper").data("nonce"),separator:o.parents(".step").find(".separator").val(),decode_quotes:o.parents(".step").find(".decode-quotes").is(":checked")?"on":"",post_type:jQuery("#post-data").data("post-type")},type:"POST",url:ajaxurl};if("local"===t.data("type")){var n=new FormData;n.append("action","vgse_upload_file_for_import"),n.append("data_type",t.data("type")),n.append("nonce",jQuery("#vgse-wrapper").data("nonce")),n.append("post_type",jQuery("#post-data").data("post-type")),n.append("separator",o.parents(".step").find(".separator").val()),n.append("decode_quotes",o.parents(".step").find(".decode-quotes").is(":checked")?"on":""),n.append("data",""),n.append("file",document.getElementById("vgse-import-local-file").files[0]),a.processData=!1,a.contentType=!1,a.data=n}else"url"===t.data("type")?a.data.data=o.find(".data").val():"server_file"===t.data("type")?a.data.data=o.find(".data").val():a.data.data=window.importHOT.getSourceData();jQuery.ajax(a).always(function(r){if(window.vgseImportData=r,loading_ajax({estado:!1}),r.success&&r.data.rowHeaders){p.find(".existing-check-csv-field").each(function(){jQuery(this).find("option:not(:eq(0))").remove()}),p.find(".import-file").val(r.data.filePath),p.find(".total-rows").val(r.data.totalRows);var e=r.data.rowHeaders;p.find(".map-template:not(.hidden)").remove(),p.find(".import-column-bulk-actions").val(""),jQuery.each(e,function(e,t){if(t){var a=p.find(".map-template.hidden").clone();a.removeClass("hidden"),a.find(".csv-column-name-text").text(t),a.find(".csv-column-name-example").append(jQuery("<span>"+r.data.firstRows[0][t]+"</span>").text().substring(0,100)),a.find(".csv-column-name-value").val(t),p.find(".map-template").last().after(a);if(-1<["ID","id","record_id"].indexOf(t))var o="ID";else o=t;var n=o.replace(/[0-9]+/g,"");vgse_editor_settings.post_type===vgse_editor_settings.woocommerce_product_post_type_key&&vgse_editor_settings.wc_repeatable_columns&&jQuery.each(vgse_editor_settings.wc_repeatable_columns,function(e,t){e.replace(/\%d/g,"")===n&&(o=t)}),p.find(".map-template").last().find("select option").each(function(){var e=jQuery(this),t=jQuery.trim(e.text());jQuery.trim(o.toLowerCase())===t.toLowerCase()&&(e.prop("selected",!0),e.parents("select").trigger("change"))}),p.find(".existing-check-csv-field").append('<option value="'+t+'">'+t+"</option>")}});var t=p.find(".map-template:not(.hidden) select").filter(function(){return!jQuery(this).val()});1===e.length?p.find(".one-column-detected-tip").show():p.find(".one-column-detected-tip").hide(),t.length?(p.find(".import-column-list-headers, .import-column-bulk-actions").show(),p.find(".map-template:not(.hidden)").show(),p.find(".import-auto-map-notice").hide(),p.find(".map-columns .button-primario.next-step").show()):(p.find(".import-auto-map-notice").show(),p.find(".import-column-list-headers, .import-column-bulk-actions").hide(),p.find(".map-columns .button-primario.next-step").hide(),p.find(".import-auto-map-notice .import-map-select-columns").click(function(e){e.preventDefault(),p.find(".import-column-list-headers, .import-column-bulk-actions").show(),p.find(".map-template:not(.hidden)").show(),p.find(".map-columns .button-primario.next-step").show()}))}else{i();var a=void 0!==r.data.message?r.data.message:"Error";notification({mensaje:"Error",tipo:"error",tiempo:18e4}),o.parents(".step").find(".file-upload-error").remove(),o.parents(".step").find(".advanced-options").before('<div class="alert alert-red file-upload-error">'+a+"</div>")}})}),vgse_editor_settings.post_type===vgse_editor_settings.woocommerce_product_post_type_key&&jQuery("body").on("change",".map-template select",function(){if(-1<jQuery(this).val().indexOf(":"))if("meta:"===jQuery(this).val()){jQuery(this).find("option:selected").attr("value",jQuery(this).parents(".map-template").find(".csv-column-name-text").text().replace("Meta: ","meta:"))}else{var t=jQuery(this).find("option:selected").attr("value").replace(/[0-9]/g,"");p.find('.map-template select option[value*="'+t+'"]:selected').each(function(e){jQuery(this).attr("value",t+e)})}});var l=jQuery(".import-csv-modal");jQuery(document).on("closed",".import-csv-modal",function(){p.show(),p.find(".step").removeClass("current").hide(),p.find(".step").first().addClass("current").show(),l.find(".import-step").hide(),l.find(".remodal-confirm").hide()}),p.append('<input type="hidden" name="wpse_source_suffix" value="'+(vgse_editor_settings.wpse_source_suffix||"")+'" />'),l.submit(function(e){e.preventDefault(),l.find(".import-step").show();var r=l.find(".import-response");r.empty(),l.find("#be-import-nanobar-container").remove(),r.before('<div id="be-import-nanobar-container" />');var t={classname:"be-progress-bar",target:document.getElementById("be-import-nanobar-container")},i=new Nanobar(t);i.go(1),p.hide(),l.find(".remodal-cancel").hide();var a=parseInt(p.find(".total-rows").val()),s={updated:0,created:0,processed:0},d=0;return p.find(".existing-check-wp-field").val()&&p.find(".auto-retry-failed-batches").prop("checked",!0),window.beImportLoop=beAjaxLoop({totalCalls:Math.ceil(a/vgse_editor_settings.save_posts_per_page),url:ajaxurl,dataType:"json",method:"POST",data:p.serializeArray(),onSuccess:function(a,o){if(d=0,!a.success)return"string"==typeof a.data.row&&(a.data.message+=". Row: "+a.data.row+"<br>"+vgse_editor_settings.texts.import_data_issue_correct_restart),r.append("<p>"+a.data.message+"</p>"),r.scrollTop(r[0].scrollHeight),i.go(100),l.find(".remodal-cancel").show(),l.find(".import-actions").hide(),!1;if(jQuery.isArray(o.data)){var n=!1;o.data.forEach(function(e,t){"file_position"===e.name&&(o.data[t].value=a.data.file_position,n=!0)}),n||o.data.push({name:"file_position",value:a.data.file_position})}else o.data.file_position=a.data.file_position;s.updated+=a.data.updated,s.created+=a.data.created,s.processed+=a.data.processed;var e=a.data.message.replace("{total_updated}",s.updated).replace("{total_created}",s.created);return o.totalCalls=Math.ceil(parseInt(a.data.total)/vgse_editor_settings.save_posts_per_page),r.empty(),r.append(e),r.scrollTop(r[0].scrollHeight),o.current===o.totalCalls||a.data.force_complete?(r.append(vgse_editor_settings.texts.import_finished),r.scrollTop(r[0].scrollHeight),i.go(100),l.find(".remodal-cancel").show(),l.find(".import-actions").hide(),vgseReloadSpreadsheet(!0),!1):(i.go(o.current/o.totalCalls*100),l.find(".remodal-cancel").hide(),l.find(".import-actions").show(),!0)},onError:function(e,t,a){if(++d<=3)var o=!!p.find(".auto-retry-failed-batches").is(":checked")||confirm(vgse_editor_settings.texts.import_failed_retry_server_error);else o=!1;return o?(window.vgseDontNotifyServerError=!0,a.current--,i.go(a.current/a.totalCalls*100),l.find(".remodal-cancel").hide(),l.find(".import-actions").show(),!0):(r.append(vgse_editor_settings.texts.import_failed_server_error_tips),r.scrollTop(r[0].scrollHeight),i.go(100),l.find(".remodal-cancel").show(),l.find(".import-actions").hide(),!1)}}),l.find(".pause-import").data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),!1}),l.find(".pause-import").click(function(e){e.preventDefault();var t=jQuery(this);"pause"===t.data("action")?(t.data("action","play").addClass("button-primary").removeClass("button-secondary").html('<i class="fa fa-play"></i> Resume'),window.beImportLoop.pause(),l.find(".remodal-cancel").show(),l.find(".remodal-confirm").show()):(t.data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),window.beImportLoop.resume(),l.find(".remodal-cancel").hide(),l.find(".remodal-confirm").hide())})}),jQuery(document).ready(function(){var d;if(!(d=jQuery(".export-csv-form")).length)return!0;(d=jQuery(".export-csv-form")).find(".export-actions").hide(),d.find(".select-all").click(function(e){e.preventDefault(),d.find(".export-columns option").prop("selected",!0).trigger("change")}),d.find(".select-active").click(function(e){e.preventDefault();var o=d.find(".export-columns");o.find("option").prop("selected",!1),jQuery.each(vgse_editor_settings.columnsFormat,function(e,t){var a=vgseColumnKeyToExportKey(e);o.find('option[value="'+a+'"]').prop("selected",!0)}),d.find(".export-columns").trigger("change")}),d.find(".unselect-all").click(function(e){e.preventDefault(),d.find(".export-columns option").prop("selected",!1).trigger("change")}),d.submit(function(e){window.beExportLoop=null;var o=jQuery(".export-response");o.empty(),d.find("#be-export-nanobar-container").remove(),o.before('<div id="be-export-nanobar-container" />');var t={classname:"be-progress-bar",target:document.getElementById("be-export-nanobar-container")},n=new Nanobar(t);n.go(1),d.find(".remodal-cancel").hide(),d.find(".remodal-confirm").hide(),d.find(".export-actions").show(),d.find(".export-columns").prop("disabled",!0).trigger("change");var r=vgse_editor_settings.export_page_size,a={action:"vgse_load_data",vgse_plain_mode:"yes",posts_per_page:r,vgse_csv_export:"yes",custom_enabled_columns:d.find(".export-columns").val().join(","),add_excel_separator_flag:d.find(".excel-compatibility-container select").val()?1:0,nonce:jQuery("#vgse-wrapper").data("nonce"),post_type:jQuery("#post-data").data("post-type"),filters:beGetRowsFilters(),export_key:[vgseFormatDate(),jQuery("#post-data").data("post-type"),vgseGuidGenerator()].join("-"),wpse_source_suffix:vgse_editor_settings.wpse_source_suffix||""};if(d.find('[name="save_for_later_name"]').val()){a.save_for_later={name:d.find('[name="save_for_later_name"]').val(),columns:a.custom_enabled_columns,add_excel_separator_flag:a.add_excel_separator_flag,filters:a.filters,post_type:a.post_type};var i=jQuery(".export_csv-container");i.find(".toolbar-submenu").length||i.append('<div class="toolbar-submenu" />');var s=i.find(".toolbar-submenu").length;i.find(".toolbar-submenu .button:contains("+a.save_for_later.name+")").parent().remove(),i.find(".toolbar-submenu").append('<div class="button-container save_export-container"><button name="save_export'+s+'" class="button" data-start-saved-export>'+a.save_for_later.name+"</button></div>"),i.find(".toolbar-submenu").find(".button").last().data("start-saved-export",a.save_for_later)}return window.beExportLoop=beAjaxLoop({totalCalls:Math.ceil(window.beFoundRows/r),url:ajaxurl,dataType:"json",method:"POST",data:a,prepareData:function(e,t){return e.paged=e.page,e},onSuccess:function(e,t){return e.success?(t.totalCalls=Math.ceil(parseInt(e.data.total)/r),o.empty(),o.append(e.data.message),o.scrollTop(o[0].scrollHeight),t.current===t.totalCalls?(e.data.export_file_url&&window.location.href.indexOf("no_redirect=1")<0&&(window.location.href=e.data.export_file_url),o.scrollTop(o[0].scrollHeight),n.go(100),d.find(".export-actions").hide(),d.find(".remodal-cancel").show(),d.find(".remodal-confirm").show(),d.find(".export-columns").prop("disabled",!1).trigger("change"),!1):(n.go(t.current/t.totalCalls*100),d.find(".remodal-cancel").hide(),!0)):(o.append("<p>"+e.data.message+"</p>"),o.scrollTop(o[0].scrollHeight),n.go(100),d.find(".remodal-cancel").show(),d.find(".remodal-confirm").show(),d.find(".export-columns").prop("disabled",!1).trigger("change"),!1)},onError:function(e,t,a){return 30<r&&(500<=e.status||"timeout"===t)?(window.vgseDontNotifyServerError=!0,r=10,a.data.posts_per_page=r,a.current=0,d.find(".remodal-cancel").hide(),!0):confirm(vgse_editor_settings.texts.formula_retry_batch)?(window.vgseDontNotifyServerError=!0,a.current--,n.go(a.current/a.totalCalls*100),d.find(".remodal-cancel").hide(),!0):(o.append(vgse_editor_settings.texts.process_execution_failed),o.scrollTop(o[0].scrollHeight),n.go(100),d.find(".remodal-cancel").show(),d.find(".remodal-confirm").show(),d.find(".export-columns").prop("disabled",!1).trigger("change"),!1)}}),d.find(".pause-export").data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),!1}),d.find(".pause-export").click(function(e){e.preventDefault();var t=jQuery(this);"pause"===t.data("action")?(t.data("action","play").addClass("button-primary").removeClass("button-secondary").html('<i class="fa fa-play"></i> Resume'),window.beExportLoop.pause(),d.find(".remodal-cancel").show(),d.find(".remodal-confirm").show(),d.find(".export-columns").prop("disabled",!1).trigger("change"),d.find(".export-actions").show()):(t.data("action","pause").addClass("button-secondary").removeClass("button-primary").html('<i class="fa fa-pause"></i> Pause'),window.beExportLoop.resume(),d.find(".remodal-cancel").hide(),d.find(".remodal-confirm").hide())}),d.find(".export-columns").change(function(){window.beExportLoop&&(window.beExportLoop.pause(),d.find(".export-actions").hide())})}),jQuery(document).ready(function(){var o=jQuery('[data-remodal-id="export-csv-modal"]');jQuery("body").on("click","[data-start-saved-export]",function(e){e.preventDefault();var t=jQuery(this).data("start-saved-export");o.remodal().open();var a=o.find(".export-columns");a.find("option").prop("selected",!1),t.columns.split(",").forEach(function(e){a.find('option[value="'+e+'"]').prop("selected",!0)}),a.trigger("change"),o.find(".excel-compatibility-container select").val(t.add_excel_separator_flag?"yes":""),jQuery("body").data("be-filters",""),beAddRowsFilter(t.filters),o.find('[name="save_for_later_name"]').val(""),o.find('[name="use_search_query"]').prop("checked",!0),o.find(".vgse-trigger-export").click()}),jQuery(document).on("opened",".export-csv-modal",function(){var o=jQuery(".export-columns");o.data("wpse-sort-fixed")||o.select2().on("select2:select",function(e){var t=e.params.data.id,a=jQuery(e.target).children("[value="+t+"]");a.detach(),jQuery(e.target).append(a).change(),o.data("wpse-sort-fixed",1)})})}),jQuery(window).load(function(){jQuery("body").on("click",".wpse-quick-access-link",function(e){e.preventDefault();var t=jQuery(this);"function"==typeof loading_ajax&&loading_ajax({estado:!0}),jQuery.get(vgse_universal_sheet_data.rest_base_url+"sheet-editor/v1/sheet/generate-quick-access?_wpnonce="+vgse_universal_sheet_data.rest_nonce+"&sheet_key="+vgse_universal_sheet_data.post_type,function(e){t.parent().find(".wpsegs-quick-access input").val(e.quick_access_url).focus(),t.parent().find(".wpsegs-quick-access").show(),"function"==typeof loading_ajax&&loading_ajax({estado:!1})})})}),jQuery(document).ready(function(){var i=jQuery('[data-remodal-id="export-csv-modal"]');if("undefined"==typeof hot||!i.length)return!0;var e=hot.getSettings().contextMenu;void 0===e.items&&(e.items={}),e.items.wpse_export_column={name:vgse_editor_settings.texts.export_column,hidden:function(){if(!hot.getSelected())return!0;var e=hot.colToProp(hot.getSelected()[0][1]);return!(i.find(".export-columns").find('option[value="'+e+'"]').length||vgse_editor_settings.export_keys_mapping&&vgse_editor_settings.export_keys_mapping[e])},callback:function(e,t,a){var o=hot.colToProp(t[0].start.col);i.remodal().open();var n=i.find(".export-columns"),r=vgseColumnKeyToExportKey(o);n.find("option").prop("selected",!1),n.find('option[value="'+r+'"]').prop("selected",!0),n.find('option[value="'+vgseColumnKeyToExportKey(hot.colToProp(1))+'"]').prop("selected",!0),n.trigger("change"),i.find('[name="use_search_query"]').prop("checked",!0),i.find(".vgse-trigger-export").click()}},hot.updateSettings({contextMenu:e})});